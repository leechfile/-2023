## APMPC 2023 A题 (1-2)

### 问题描述

数出图片中的苹果个数以及检测出苹果的位置，

类似于:(写一个示例)



**思路分析:**



针对问题一和问题二，即统计每幅图像中苹果的数量和所有苹果的位置，这是一个相似的苹果识别问题，因此我们将其合并一起解决。

人工处理虽能胜任有限数量图片，但难以实现高度自动化及大规模图片的高效识别。为解决此挑战，首先，我们可以采用传统的图像处理方法来检测苹果。这包括颜色空间转换、二值化等技术，以提取苹果的图像特征。接下来，我们再对经过处理的图像进行轮廓检测，以确定苹果的质心位置。

这种传统的方式虽然计算量小但局限在有限的精度，因此我们还可以尝试YOLOv5算法来检测物体，YOLO算法能够基于图片，提取图像中各个尺度的特征，能够精准捕捉物体实际位置。

我们考虑用YOLOv5目标检测算法进行苹果的计数和位置坐标分析。YOLOv5具备实时性、高效性、准确性以及开源性的特点，有助于在实际采摘作业中大规模部署。主要解决思路如下：

**第一阶段—实践传统方法**运用传统的轮廓检测等方法对苹果图像进行分析，获取初步识别结果。这一阶段为后续深度学习模型提供基准，同时传统的图像预处理方法可用于训练数据的预处理。

**第二阶段—数据准备：** 对图像进行预处理，包括剔除无效数据、数据增强等，然后详细标注提供的苹果图像，确保每个苹果及其位置准确识别。标注过程注重精度和一致性，保障后续模型训练的质量和性能。

**第三阶段—YOLOv5算法的训练：** 运用YOLOv5算法对详细标注的苹果图像进行训练。通过该算法的高度可调性，调整模型参数和权重，实现准确识别苹果数量和位置。

**第四阶段—苹果的数量估算与位置计算:** 利用经过YOLOv5算法精细训练的模型进行推理，实现对苹果数量和位置坐标的准确估算。最终识别附件1所有图像中的苹果，并计算其数量，绘制苹果数量的分布直方图。这一方法在实际果园环境中表现出色，为果园管理提供高效、自动化的解决方案。

### 传统轮廓检测苹果

在数字图像中自动检测与定位水果是农业机器人领域的关键步骤，特别是对于收割和产量估计等任务。本方法利用二值化，轮廓检测等方法检测了苹果的数量。

**一、颜色空间转换**

我们首先基于颜色来检测苹果。由于RGB颜色空间易受光照变化的影响，因此不适合用于此目的。所以首先将图像转换为HSV颜色空间，它对光照变化更为稳定。

我们可以看到图像转换成HSV颜色空间后，具有苹果的图像更加的醒目以及显著，这样对于我们进行苹果数量以及位置的检测更加的便利。

**二、颜色阈值转换**

为了更好的选定苹果的范围，对苹果进行检测，我们为苹果颜色选定了相对应的颜色范围在这个范围内的像素被设置为白色，其他的设置为黑色，得到的二值图像突出了潜在的苹果区域。

设定苹果颜色范围为I,U，操作如下:

                                      

**三、图像的去噪处理**

二值图像可能包含噪点和苹果区域内的间隙。应用如开操作（先腐蚀后膨胀）来移除小噪点，闭操作（先膨胀后腐蚀）来填补小间隙。

图像去噪与原始二值化图像对比如下，可以看到经过去噪后，图像的色块更加集中，对于后续的边缘检测效果更好。

Figure 2: Image Comparison

**四、轮廓检测以及轮廓筛选**

对图像进行完清理后，我们可以找到它们的轮廓，每一个轮廓对应一个苹果的潜在边界，我们根据苹果的面积以及形状来筛选轮廓。给定轮廓*C*，其面积*A*，周长*P*，圆度可以表示如下：

                           

其中，圆度越接近于1，苹果的概率越大。

最终的轮廓检测效果图如下：



Figure 3: Contour Detection

可以看到该方法能够很好的检测到区域内苹果的位置，以及边缘。

**五、图像定位与计数。**

计算每个筛选后轮廓的质心，作为苹果的估计位置。质心的数量给出了图像中苹果的数量。

轮廓*C*的质心和计算如下，*M*为轮廓的矩：

               



矩的计算如下:

- **零阶矩**：零阶矩是轮廓内所有像素的总和； 表示轮廓内的像素数，即苹果的大小。
- **一阶矩**和：一阶矩分别用于计算质心的水平坐标  和垂直坐标 。它们的计算方式如下：

o   表示轮廓内每个像素的*x*坐标值之和。

o   表示轮廓内每个像素的*y*坐标值之和。

最终我们可以得到该示例图片中有四个苹果，每个检测出苹果的位置如下:

(253, 176), (75, 172), (259, 145), (137, 99)



### YOLOV5算法

     
